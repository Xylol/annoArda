name: Claude Agent

on:
  issues:
    types: [opened, labeled]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

jobs:
  claude-work-on-issue:
    if: |
      github.event_name == 'issues' &&
      contains(github.event.issue.labels.*.name, 'claude') &&
      !contains(github.event.issue.labels.*.name, 'claude-processed') &&
      github.event.issue.user.login == github.repository_owner

    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Work on issue
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Work on issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            ${{ github.event.issue.body }}

            Requirements:
            - Create a new branch named 'claude/issue-${{ github.event.issue.number }}'
            - Make the necessary code changes to resolve this issue
            - Commit your changes with clear, descriptive messages
            - Create a pull request that references this issue with "Fixes #${{ github.event.issue.number }}"
            - Add the label "claude-processed" to the original issue

            Do not push to main or master branches.
          claude_args: --max-turns 100
          settings: |
            {
              "permissions": {
                "allow": ["Bash", "Read", "Edit", "Write", "Glob", "Grep", "Bash(git:*)", "Bash(gh:*)", "Bash(npm:*)", "Bash(node:*)"],
                "deny": []
              },
              "permissionMode": "allowlist"
            }

      - name: Verify task completion
        run: |
          # Check if PR was created for this issue
          BRANCH_NAME="claude/issue-${{ github.event.issue.number }}"
          PR_COUNT=$(gh pr list --repo ${{ github.repository }} --head "$BRANCH_NAME" --json number --jq 'length')

          if [ "$PR_COUNT" -eq 0 ]; then
            echo "Error: No pull request was created from branch $BRANCH_NAME"
            gh issue comment ${{ github.event.issue.number }} \
              --repo ${{ github.repository }} \
              --body "Task incomplete: No pull request was created. Please check the workflow logs for details."
            exit 1
          fi

          echo "Verification passed: PR created successfully"
          gh issue comment ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --body "Processing complete. Please review the pull request."
        env:
          GH_TOKEN: ${{ github.token }}

  claude-respond-to-feedback:
    if: |
      (github.event_name == 'pull_request_review' && github.event.review.state != 'approved') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request != null)

    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Respond to feedback
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            This pull request has received feedback. Please address the following:

            ${{ github.event.review.body || github.event.comment.body }}

            Instructions:
            - Read all review comments and change requests
            - Implement the requested changes
            - Commit with a clear message describing what feedback you addressed
            - Push to the same branch to update the PR
            - Add a comment explaining what you changed

            Do not create a new PR or push to main/master.
          claude_args: --max-turns 30
          settings: |
            {
              "permissions": {
                "allow": ["Bash", "Read", "Edit", "Write", "Glob", "Grep", "Bash(git:*)", "Bash(gh:*)", "Bash(npm:*)", "Bash(node:*)"],
                "deny": []
              },
              "permissionMode": "allowlist"
            }

      - name: Verify changes were pushed
        run: |
          # Get PR number
          if [ "${{ github.event_name }}" == "pull_request_review" ]; then
            PR_NUMBER=${{ github.event.pull_request.number }}
          else
            PR_NUMBER=${{ github.event.issue.number }}
          fi

          # Check if there are new commits in the last 5 minutes
          RECENT_COMMITS=$(gh pr view $PR_NUMBER --repo ${{ github.repository }} --json commits --jq '.commits[-1].committedDate')

          if [ -z "$RECENT_COMMITS" ]; then
            echo "Error: No commits found in PR"
            gh pr comment $PR_NUMBER \
              --repo ${{ github.repository }} \
              --body "Task incomplete: Failed to address feedback. Please check the workflow logs."
            exit 1
          fi

          echo "Verification passed: Changes pushed successfully"
          gh pr comment $PR_NUMBER \
            --repo ${{ github.repository }} \
            --body "Feedback addressed. Please review the changes."
        env:
          GH_TOKEN: ${{ github.token }}
