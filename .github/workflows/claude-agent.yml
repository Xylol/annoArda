name: Claude Agent

on:
  issues:
    types: [opened, labeled]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

jobs:
  claude-work-on-issue:
    if: |
      github.event_name == 'issues' &&
      contains(github.event.issue.labels.*.name, 'claude') &&
      !contains(github.event.issue.labels.*.name, 'claude-processed') &&
      github.event.issue.user.login == github.repository_owner

    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Work on issue
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Work on issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            ${{ github.event.issue.body }}

            Requirements:
            - Create a new branch named 'claude/issue-${{ github.event.issue.number }}'
            - Make the necessary code changes to resolve this issue
            - Commit your changes with clear, descriptive messages
            - Create a pull request that references this issue with "Fixes #${{ github.event.issue.number }}"
            - Add the label "claude-processed" to the original issue

            Do not push to main or master branches.
          claude_args: --max-turns 50

  claude-respond-to-feedback:
    if: |
      (github.event_name == 'pull_request_review' && github.event.review.state != 'approved') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request != null)

    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Respond to feedback
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            This pull request has received feedback. Please address the following:

            ${{ github.event.review.body || github.event.comment.body }}

            Instructions:
            - Read all review comments and change requests
            - Implement the requested changes
            - Commit with a clear message describing what feedback you addressed
            - Push to the same branch to update the PR
            - Add a comment explaining what you changed

            Do not create a new PR or push to main/master.
          claude_args: --max-turns 30
